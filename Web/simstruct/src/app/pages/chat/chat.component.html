<div class="chat-hub">
  <!-- Animated Background -->
  <div class="background-effects">
    <div class="gradient-orb orb-1"></div>
    <div class="gradient-orb orb-2"></div>
    <div class="gradient-orb orb-3"></div>
    <div class="grid-pattern"></div>
  </div>

  <!-- Header -->
  <header class="chat-header">
    <button class="back-button" (click)="goBack()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M19 12H5M12 19l-7-7 7-7"/>
      </svg>
    </button>
    
    <div class="friend-info">
      <div class="avatar-wrapper">
        <div class="avatar">
          <span>{{ getInitials(friendName()) }}</span>
        </div>
        <span class="status-indicator online"></span>
      </div>
      <div class="info-text">
        <h1>{{ friendName() || 'Loading...' }}</h1>
        <span class="status-text">Active now</span>
      </div>
    </div>

    <div class="header-actions">
      <button class="action-btn" title="Voice Call" disabled>
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
        </svg>
      </button>
      <button class="action-btn" title="Video Call" disabled>
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polygon points="23 7 16 12 23 17 23 7"/>
          <rect x="1" y="5" width="15" height="14" rx="2" ry="2"/>
        </svg>
      </button>
    </div>
  </header>

  <!-- Main Content Area -->
  <main class="chat-main">
    <!-- Loading State -->
    @if (isLoading()) {
      <div class="loading-state">
        <div class="loader">
          <div class="loader-ring"></div>
          <div class="loader-ring"></div>
          <div class="loader-ring"></div>
        </div>
        <p>Connecting to {{ friendName() }}...</p>
      </div>
    } @else {
      <!-- Three Panel Layout -->
      <div class="panels-container">
        
        <!-- Panel 1: Chat Messages -->
        <section class="panel chat-panel" [class.expanded]="activePanel() === 'chat'">
          <div class="panel-header" (click)="setActivePanel('chat')">
            <div class="panel-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
              </svg>
            </div>
            <h2>Messages</h2>
            <button class="expand-btn">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="15 3 21 3 21 9"/>
                <polyline points="9 21 3 21 3 15"/>
                <line x1="21" y1="3" x2="14" y2="10"/>
                <line x1="3" y1="21" x2="10" y2="14"/>
              </svg>
            </button>
          </div>
          
          <div class="panel-content">
            <!-- Messages List -->
            <div class="messages-container" #messagesContainer>
              @if (messages().length === 0) {
                <div class="empty-messages">
                  <div class="empty-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                      <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/>
                    </svg>
                  </div>
                  <h3>Start the conversation</h3>
                  <p>Send a message or share a simulation</p>
                </div>
              } @else {
                @for (message of messages(); track message.id) {
                  <div class="message" [class.own]="isOwnMessage(message)" [class.other]="!isOwnMessage(message)">
                    @if (!isOwnMessage(message)) {
                      <div class="message-avatar">
                        <span>{{ getInitials(message.senderName) }}</span>
                      </div>
                    }
                    <div class="message-bubble">
                      <p class="message-text">{{ message.content }}</p>
                      <span class="message-time">{{ formatTime(message.sentAt) }}</span>
                    </div>
                    @if (isOwnMessage(message)) {
                      <div class="message-status">
                        @if (message.isRead) {
                          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="20 6 9 17 4 12"/>
                            <polyline points="16 6 5 17"/>
                          </svg>
                        } @else {
                          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="20 6 9 17 4 12"/>
                          </svg>
                        }
                      </div>
                    }
                  </div>
                }
              }
            </div>
            
            <!-- Message Input -->
            <div class="message-input-area">
              <button class="attachment-btn" (click)="openShareModal()" title="Share Simulation">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="18" cy="5" r="3"/>
                  <circle cx="6" cy="12" r="3"/>
                  <circle cx="18" cy="19" r="3"/>
                  <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/>
                  <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
                </svg>
              </button>
              <div class="input-wrapper">
                <input 
                  type="text" 
                  placeholder="Type a message..."
                  [value]="messageInput()"
                  (input)="updateInput($event)"
                  (keypress)="handleKeyPress($event)"
                >
              </div>
              <button class="send-btn" (click)="sendMessage()" [disabled]="!messageInput().trim()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="22" y1="2" x2="11" y2="13"/>
                  <polygon points="22 2 15 22 11 13 2 9 22 2"/>
                </svg>
              </button>
            </div>
          </div>
        </section>

        <!-- Panel 2: Shared Simulations -->
        <section class="panel simulations-panel" [class.expanded]="activePanel() === 'simulations'">
          <div class="panel-header" (click)="setActivePanel('simulations')">
            <div class="panel-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/>
              </svg>
            </div>
            <h2>Simulations</h2>
            <span class="count">{{ totalSharedCount() }}</span>
            <button class="expand-btn">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="15 3 21 3 21 9"/>
                <polyline points="9 21 3 21 3 15"/>
                <line x1="21" y1="3" x2="14" y2="10"/>
                <line x1="3" y1="21" x2="10" y2="14"/>
              </svg>
            </button>
          </div>
          
          <div class="panel-content">
            <!-- Tabs -->
            <div class="sim-tabs">
              <button 
                class="tab-btn" 
                [class.active]="simulationTab() === 'sent'"
                (click)="simulationTab.set('sent')"
              >
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="22" y1="2" x2="11" y2="13"/>
                  <polygon points="22 2 15 22 11 13 2 9 22 2"/>
                </svg>
                Sent
                <span class="tab-count">{{ sharedWithPartner().length }}</span>
              </button>
              <button 
                class="tab-btn" 
                [class.active]="simulationTab() === 'received'"
                (click)="simulationTab.set('received')"
              >
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="22 12 16 12 14 15 10 15 8 12 2 12"/>
                  <path d="M5.45 5.11L2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z"/>
                </svg>
                Received
                <span class="tab-count">{{ sharedByPartner().length }}</span>
              </button>
            </div>
            
            <!-- Simulations List -->
            <div class="simulations-list">
              @if (simulationTab() === 'sent') {
                @if (sharedWithPartner().length === 0) {
                  <div class="empty-simulations">
                    <div class="empty-icon">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <circle cx="18" cy="5" r="3"/>
                        <circle cx="6" cy="12" r="3"/>
                        <circle cx="18" cy="19" r="3"/>
                      </svg>
                    </div>
                    <h4>No simulations shared</h4>
                    <p>Share your work with {{ friendName() }}</p>
                    <button class="share-now-btn" (click)="openShareModal()">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/>
                        <polyline points="16 6 12 2 8 6"/>
                        <line x1="12" y1="2" x2="12" y2="15"/>
                      </svg>
                      Share Now
                    </button>
                  </div>
                } @else {
                  @for (sim of sharedWithPartner(); track sim.id) {
                    <div class="simulation-card" (click)="viewSimulationDetail(sim)">
                      <div class="sim-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                          <line x1="3" y1="9" x2="21" y2="9"/>
                          <line x1="9" y1="21" x2="9" y2="9"/>
                        </svg>
                      </div>
                      <div class="sim-info">
                        <h4>{{ sim.name }}</h4>
                        <span class="sim-type">{{ sim.structureType }}</span>
                      </div>
                      <div class="sim-meta">
                        @if (sim.safetyFactor) {
                          <span class="safety-badge" [class]="getSafetyClass(sim.safetyFactor)">
                            SF {{ sim.safetyFactor.toFixed(1) }}
                          </span>
                        }
                      </div>
                      <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="9 18 15 12 9 6"/>
                      </svg>
                    </div>
                  }
                }
              } @else {
                @if (sharedByPartner().length === 0) {
                  <div class="empty-simulations">
                    <div class="empty-icon">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <polyline points="22 12 16 12 14 15 10 15 8 12 2 12"/>
                        <path d="M5.45 5.11L2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89"/>
                      </svg>
                    </div>
                    <h4>No simulations received</h4>
                    <p>{{ friendName() }} hasn't shared anything yet</p>
                  </div>
                } @else {
                  @for (sim of sharedByPartner(); track sim.id) {
                    <div class="simulation-card received" (click)="viewReceivedSimulation(sim)">
                      <div class="sim-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                          <line x1="3" y1="9" x2="21" y2="9"/>
                          <line x1="9" y1="21" x2="9" y2="9"/>
                        </svg>
                      </div>
                      <div class="sim-info">
                        <h4>{{ sim.simulationName }}</h4>
                        <span class="sim-type">From {{ sim.sharedByName }}</span>
                      </div>
                      <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="9 18 15 12 9 6"/>
                      </svg>
                    </div>
                  }
                }
              }
            </div>
          </div>
        </section>

        <!-- Panel 3: Simulation Details -->
        <section class="panel details-panel" [class.expanded]="activePanel() === 'details'" [class.has-content]="selectedSimulation()">
          <div class="panel-header" (click)="setActivePanel('details')">
            <div class="panel-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <line x1="12" y1="16" x2="12" y2="12"/>
                <line x1="12" y1="8" x2="12.01" y2="8"/>
              </svg>
            </div>
            <h2>Details</h2>
            <button class="expand-btn">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="15 3 21 3 21 9"/>
                <polyline points="9 21 3 21 3 15"/>
                <line x1="21" y1="3" x2="14" y2="10"/>
                <line x1="3" y1="21" x2="10" y2="14"/>
              </svg>
            </button>
          </div>
          
          <div class="panel-content">
            @if (!selectedSimulation()) {
              <div class="empty-details">
                <div class="empty-icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                    <circle cx="8.5" cy="8.5" r="1.5"/>
                    <polyline points="21 15 16 10 5 21"/>
                  </svg>
                </div>
                <h4>Select a simulation</h4>
                <p>Click on any simulation to view details</p>
              </div>
            } @else {
              <div class="detail-view">
                <button class="close-detail" (click)="clearSelectedSimulation()">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"/>
                    <line x1="6" y1="6" x2="18" y2="18"/>
                  </svg>
                </button>
                
                <div class="detail-header">
                  <h3>{{ selectedSimulation()!.name }}</h3>
                  @if (selectedSimulation()!.description) {
                    <p class="description">{{ selectedSimulation()!.description }}</p>
                  }
                </div>
                
                @if (selectedSimulation()!.results) {
                  <div class="safety-card" [class]="getSafetyClass(selectedSimulation()!.results!.safetyFactor)">
                    <div class="safety-visual">
                      <div class="safety-ring">
                        <svg viewBox="0 0 100 100">
                          <circle cx="50" cy="50" r="45" fill="none" stroke="currentColor" stroke-width="8" opacity="0.2"/>
                          <circle cx="50" cy="50" r="45" fill="none" stroke="currentColor" stroke-width="8" 
                            [attr.stroke-dasharray]="getSafetyDashArray(selectedSimulation()!.results!.safetyFactor)"
                            stroke-linecap="round"
                            transform="rotate(-90 50 50)"/>
                        </svg>
                        <span class="safety-value">{{ selectedSimulation()!.results!.safetyFactor.toFixed(2) }}</span>
                      </div>
                    </div>
                    <div class="safety-info">
                      <span class="safety-label">Safety Factor</span>
                      <span class="safety-status">
                        @if (selectedSimulation()!.results!.safetyFactor >= 1.5) {
                          ‚úì Safe Structure
                        } @else if (selectedSimulation()!.results!.safetyFactor >= 1.0) {
                          ‚ö† Needs Review
                        } @else {
                          ‚úï Critical
                        }
                      </span>
                    </div>
                  </div>
                }
                
                <div class="properties-grid">
                  <div class="property-card">
                    <span class="prop-label">Type</span>
                    <span class="prop-value">{{ selectedSimulation()!.supportType }}</span>
                  </div>
                  <div class="property-card">
                    <span class="prop-label">Material</span>
                    <span class="prop-value">{{ selectedSimulation()!.materialType }}</span>
                  </div>
                  <div class="property-card">
                    <span class="prop-label">Dimensions</span>
                    <span class="prop-value">{{ selectedSimulation()!.beamLength }}√ó{{ selectedSimulation()!.beamWidth }}√ó{{ selectedSimulation()!.beamHeight }}m</span>
                  </div>
                  <div class="property-card">
                    <span class="prop-label">Load</span>
                    <span class="prop-value">{{ selectedSimulation()!.loadMagnitude }} kN</span>
                  </div>
                </div>
                
                @if (selectedSimulation()!.results) {
                  <div class="results-cards">
                    <div class="result-card stress">
                      <span class="result-icon">üìä</span>
                      <div class="result-info">
                        <span class="result-label">Max Stress</span>
                        <span class="result-value">{{ selectedSimulation()!.results!.maxStress.toFixed(2) }} MPa</span>
                      </div>
                    </div>
                    <div class="result-card displacement">
                      <span class="result-icon">üìê</span>
                      <div class="result-info">
                        <span class="result-label">Max Deflection</span>
                        <span class="result-value">{{ (selectedSimulation()!.results!.maxDeflection * 1000).toFixed(2) }} mm</span>
                      </div>
                    </div>
                  </div>
                }
                
                <button class="view-full-btn" (click)="viewFullResults()">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
                    <polyline points="15 3 21 3 21 9"/>
                    <line x1="10" y1="14" x2="21" y2="3"/>
                  </svg>
                  View Full Analysis
                </button>
              </div>
            }
          </div>
        </section>
      </div>
    }
  </main>

  <!-- Share Modal -->
  @if (showShareModal()) {
    <div class="modal-overlay" (click)="closeShareModal()">
      <div class="share-modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>Share Simulation</h2>
          <button class="close-btn" (click)="closeShareModal()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18"/>
              <line x1="6" y1="6" x2="18" y2="18"/>
            </svg>
          </button>
        </div>
        
        <div class="modal-body">
          <p class="modal-subtitle">Share with {{ friendName() }}</p>
          
          @if (mySimulations().length === 0) {
            <div class="no-sims">
              <p>No simulations to share</p>
              <button routerLink="/simulation">Create One</button>
            </div>
          } @else {
            <div class="sim-list">
              @for (sim of mySimulations(); track sim.id) {
                <div 
                  class="sim-option" 
                  [class.selected]="selectedShareSimulation()?.id === sim.id"
                  (click)="selectShareSimulation(sim)"
                >
                  <div class="sim-option-info">
                    <span class="sim-name">{{ sim.name }}</span>
                    <span class="sim-meta">{{ sim.structureType }}</span>
                  </div>
                  <div class="check-circle">
                    @if (selectedShareSimulation()?.id === sim.id) {
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20 6 9 17 4 12"/>
                      </svg>
                    }
                  </div>
                </div>
              }
            </div>
            
            @if (selectedShareSimulation()) {
              <div class="message-field">
                <label>Message (optional)</label>
                <textarea 
                  placeholder="Add a note..."
                  [value]="shareMessage()"
                  (input)="updateShareMessage($event)"
                ></textarea>
              </div>
            }
          }
        </div>
        
        <div class="modal-footer">
          <button class="btn-secondary" (click)="closeShareModal()">Cancel</button>
          <button 
            class="btn-primary" 
            [disabled]="!selectedShareSimulation() || isSharingSimulation()"
            (click)="shareSimulation()"
          >
            @if (isSharingSimulation()) {
              <span class="spinner"></span> Sharing...
            } @else {
              Share
            }
          </button>
        </div>
      </div>
    </div>
  }
</div>
