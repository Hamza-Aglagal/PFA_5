<div class="chat-container">
  <!-- Subtle Background -->
  <div class="bg-gradient"></div>

  <!-- Main Chat Layout -->
  <div class="chat-layout">

    <!-- Left: Chat Area -->
    <div class="chat-area">
      <!-- Chat Header -->
      <header class="chat-header">
        <button class="back-btn" (click)="goBack()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 12H5M12 19l-7-7 7-7" />
          </svg>
        </button>

        <div class="contact-info">
          <div class="avatar">
            <span>{{ getInitials(friendName()) }}</span>
            <span class="online-dot"></span>
          </div>
          <div class="contact-details">
            <h2>{{ friendName() || 'Loading...' }}</h2>
            <span class="status">Online</span>
          </div>
        </div>

        <div class="header-actions">
          <button class="icon-btn" (click)="openShareModal()" title="Share Simulation">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="18" cy="5" r="3" />
              <circle cx="6" cy="12" r="3" />
              <circle cx="18" cy="19" r="3" />
              <line x1="8.59" y1="13.51" x2="15.42" y2="17.49" />
              <line x1="15.41" y1="6.51" x2="8.59" y2="10.49" />
            </svg>
          </button>
          <button class="icon-btn" (click)="toggleSidebar()" [class.active]="showSidebar()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="3" width="18" height="18" rx="2" />
              <line x1="15" y1="3" x2="15" y2="21" />
            </svg>
          </button>
        </div>
      </header>

      <!-- Messages Area -->
      <div class="messages-area" #messagesContainer>
        @if (isLoading()) {
        <div class="loading-spinner">
          <div class="spinner"></div>
          <p>Loading messages...</p>
        </div>
        } @else if (messages().length === 0) {
        <div class="empty-chat">
          <div class="empty-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path
                d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z" />
            </svg>
          </div>
          <h3>Start the conversation</h3>
          <p>Send a message or share a simulation with {{ friendName() }}</p>
        </div>
        } @else {
        <div class="messages-list">
          @for (message of messages(); track message.id) {
          <div class="message" [class.sent]="isOwnMessage(message)" [class.received]="!isOwnMessage(message)">
            @if (!isOwnMessage(message)) {
            <div class="msg-avatar">{{ getInitials(message.senderName) }}</div>
            }
            <div class="msg-content">
              <div class="msg-bubble">
                <p>{{ message.content }}</p>
              </div>
              <span class="msg-time">
                {{ formatTime(message.sentAt) }}
                @if (isOwnMessage(message) && message.isRead) {
                <svg class="read-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="20 6 9 17 4 12" />
                </svg>
                }
              </span>
            </div>
          </div>
          }
        </div>
        }
      </div>

      <!-- Message Input -->
      <div class="input-area">
        <div class="input-wrapper">
          <input type="text" placeholder="Type your message..." [value]="messageInput()" (input)="updateInput($event)"
            (keypress)="handleKeyPress($event)">
          <button class="send-btn" (click)="sendMessage()" [disabled]="!messageInput().trim()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="22" y1="2" x2="11" y2="13" />
              <polygon points="22 2 15 22 11 13 2 9 22 2" />
            </svg>
          </button>
        </div>
      </div>
    </div>

    <!-- Right: Sidebar -->
    <aside class="sidebar" [class.visible]="showSidebar()">
      <!-- Sidebar Header -->
      <div class="sidebar-header">
        <h3>Shared Content</h3>
        <span class="badge">{{ totalSharedCount() }}</span>
      </div>

      <!-- Tabs -->
      <div class="sidebar-tabs">
        <button [class.active]="simulationTab() === 'sent'" (click)="simulationTab.set('sent')">
          Sent <span>{{ sharedWithPartner().length }}</span>
        </button>
        <button [class.active]="simulationTab() === 'received'" (click)="simulationTab.set('received')">
          Received <span>{{ sharedByPartner().length }}</span>
        </button>
      </div>

      <!-- Content -->
      <div class="sidebar-content">
        @if (simulationTab() === 'sent') {
        @if (sharedWithPartner().length === 0) {
        <div class="empty-sidebar">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <circle cx="18" cy="5" r="3" />
            <circle cx="6" cy="12" r="3" />
            <circle cx="18" cy="19" r="3" />
          </svg>
          <p>No simulations shared yet</p>
          <button class="share-btn" (click)="openShareModal()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8" />
              <polyline points="16 6 12 2 8 6" />
              <line x1="12" y1="2" x2="12" y2="15" />
            </svg>
            Share Simulation
          </button>
        </div>
        } @else {
        <div class="sim-list">
          @for (sim of sharedWithPartner(); track sim.id) {
          <div class="sim-item" [class.selected]="selectedSimulation()?.id === sim.id"
            (click)="viewSimulationDetail(sim)" (keydown.enter)="viewSimulationDetail(sim)" tabindex="0" role="button">
            <div class="sim-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="18" height="18" rx="2" />
                <line x1="3" y1="9" x2="21" y2="9" />
              </svg>
            </div>
            <div class="sim-details">
              <span class="sim-name">{{ sim.name }}</span>
              <span class="sim-type">{{ sim.structureType }}</span>
            </div>
            @if (sim.safetyFactor) {
            <span class="safety-tag" [class]="getSafetyClass(sim.safetyFactor)">
              {{ sim.safetyFactor.toFixed(1) }}
            </span>
            }
          </div>
          }
        </div>
        }
        } @else {
        @if (sharedByPartner().length === 0) {
        <div class="empty-sidebar">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <polyline points="22 12 16 12 14 15 10 15 8 12 2 12" />
            <path d="M5.45 5.11L2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89" />
          </svg>
          <p>No simulations received yet</p>
        </div>
        } @else {
        <div class="sim-list">
          @for (sim of sharedByPartner(); track sim.id) {
          <div class="sim-item" (click)="viewReceivedSimulation(sim)" (keydown.enter)="viewReceivedSimulation(sim)"
            tabindex="0" role="button">
            <div class="sim-icon received">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="18" height="18" rx="2" />
                <line x1="3" y1="9" x2="21" y2="9" />
              </svg>
            </div>
            <div class="sim-details">
              <span class="sim-name">{{ sim.simulationName }}</span>
              <span class="sim-type">From {{ sim.sharedByName }}</span>
            </div>
          </div>
          }
        </div>
        }
        }

        <!-- Detail View -->
        @if (selectedSimulation()) {
        <div class="detail-panel">
          <div class="detail-header">
            <h4>{{ selectedSimulation()!.name }}</h4>
            <button class="close-btn" (click)="clearSelectedSimulation()">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18" />
                <line x1="6" y1="6" x2="18" y2="18" />
              </svg>
            </button>
          </div>

          @if (selectedSimulation()!.results) {
          <div class="safety-display" [class]="getSafetyClass(selectedSimulation()!.results!.safetyFactor)">
            <div class="safety-circle">
              <span class="value">{{ selectedSimulation()!.results!.safetyFactor.toFixed(2) }}</span>
              <span class="label">Safety Factor</span>
            </div>
          </div>
          }

          <div class="detail-grid">
            <div class="detail-item">
              <span class="label">Type</span>
              <span class="value">{{ selectedSimulation()!.supportType }}</span>
            </div>
            <div class="detail-item">
              <span class="label">Material</span>
              <span class="value">{{ selectedSimulation()!.materialType }}</span>
            </div>
            <div class="detail-item">
              <span class="label">Dimensions</span>
              <span class="value">{{ selectedSimulation()!.beamLength }}×{{ selectedSimulation()!.beamWidth }}×{{
                selectedSimulation()!.beamHeight }}m</span>
            </div>
            <div class="detail-item">
              <span class="label">Load</span>
              <span class="value">{{ selectedSimulation()!.loadMagnitude }} kN</span>
            </div>
          </div>

          @if (selectedSimulation()!.results) {
          <div class="results-row">
            <div class="result">
              <span class="result-value">{{ selectedSimulation()!.results!.maxStress.toFixed(2) }}</span>
              <span class="result-label">Max Stress (MPa)</span>
            </div>
            <div class="result">
              <span class="result-value">{{ (selectedSimulation()!.results!.maxDeflection * 1000).toFixed(2) }}</span>
              <span class="result-label">Deflection (mm)</span>
            </div>
          </div>
          }

          <button class="view-btn" (click)="viewFullResults()">
            View Full Analysis
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="9 18 15 12 9 6" />
            </svg>
          </button>
        </div>
        }
      </div>
    </aside>
  </div>

  <!-- Share Modal -->
  @if (showShareModal()) {
  <div class="modal-backdrop" (click)="closeShareModal()" (keydown.enter)="closeShareModal()" tabindex="0" role="button"
    aria-label="Close modal" aria-modal="true">
    <div class="modal" (click)="$event.stopPropagation()" (keydown.enter)="$event.stopPropagation()" role="dialog"
      aria-modal="true">
      <div class="modal-header">
        <h3>Share Simulation</h3>
        <button class="modal-close" (click)="closeShareModal()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18" />
            <line x1="6" y1="6" x2="18" y2="18" />
          </svg>
        </button>
      </div>

      <div class="modal-content">
        <p class="modal-info">Share with <strong>{{ friendName() }}</strong></p>

        @if (mySimulations().length === 0) {
        <div class="modal-empty">
          <p>No simulations to share</p>
          <button routerLink="/simulation">Create Simulation</button>
        </div>
        } @else {
        <div class="modal-list" role="listbox">
          @for (sim of mySimulations(); track sim.id) {
          <div class="modal-item" [class.selected]="selectedShareSimulation()?.id === sim.id"
            (click)="selectShareSimulation(sim)" (keydown.enter)="selectShareSimulation(sim)" tabindex="0" role="option"
            [attr.aria-selected]="selectedShareSimulation()?.id === sim.id ? 'true' : 'false'">
            <div class="item-info">
              <span class="item-name">{{ sim.name }}</span>
              <span class="item-meta">{{ sim.structureType }}</span>
            </div>
            <div class="item-check">
              @if (selectedShareSimulation()?.id === sim.id) {
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="20 6 9 17 4 12" />
              </svg>
              }
            </div>
          </div>
          }
        </div>

        @if (selectedShareSimulation()) {
        <div class="modal-message">
          <label for="share-message">Add a note (optional)</label>
          <textarea id="share-message" placeholder="Write a message..." [value]="shareMessage()"
            (input)="updateShareMessage($event)"></textarea>
        </div>
        }
        }
      </div>

      <div class="modal-actions">
        <button class="btn-cancel" (click)="closeShareModal()">Cancel</button>
        <button class="btn-share" [disabled]="!selectedShareSimulation() || isSharingSimulation()"
          (click)="shareSimulation()">
          @if (isSharingSimulation()) {
          <span class="btn-spinner"></span> Sharing...
          } @else {
          Share
          }
        </button>
      </div>
    </div>
  </div>
  }
</div>