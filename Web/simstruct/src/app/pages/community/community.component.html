<div class="community-page">
  <!-- Header -->
  <header class="community-header">
    <div class="header-content">
      <div class="header-left">
        <h1>Community</h1>
        <p class="header-subtitle">Explore, share, and collaborate on structural simulations</p>
      </div>
      <div class="header-actions">
        <button class="btn btn-outline" (click)="openInviteModal()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
            <circle cx="8.5" cy="7" r="4" />
            <line x1="20" y1="8" x2="20" y2="14" />
            <line x1="23" y1="11" x2="17" y2="11" />
          </svg>
          Invite Friend
        </button>
        <a routerLink="/simulation" class="btn btn-primary">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="12" y1="5" x2="12" y2="19" />
            <line x1="5" y1="12" x2="19" y2="12" />
          </svg>
          New Simulation
        </a>
      </div>
    </div>
  </header>

  <!-- Tabs -->
  <nav class="community-tabs">
    <button class="tab-btn" [class.active]="activeTab() === 'explore'" (click)="setTab('explore')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="11" cy="11" r="8" />
        <line x1="21" y1="21" x2="16.65" y2="16.65" />
      </svg>
      Explore
      <span class="tab-count">{{ filteredSimulations().length }}</span>
    </button>
    <button class="tab-btn" [class.active]="activeTab() === 'friends'" (click)="setTab('friends')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
        <circle cx="9" cy="7" r="4" />
        <path d="M23 21v-2a4 4 0 0 0-3-3.87" />
        <path d="M16 3.13a4 4 0 0 1 0 7.75" />
      </svg>
      Friends
      @if (pendingRequests().length > 0) {
      <span class="tab-badge">{{ pendingRequests().length }}</span>
      } @else {
      <span class="tab-count">{{ communityService.allFriends().length }}</span>
      }
    </button>
    <button class="tab-btn" [class.active]="activeTab() === 'invitations'" (click)="setTab('invitations')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
        <line x1="16" y1="2" x2="16" y2="6" />
        <line x1="8" y1="2" x2="8" y2="6" />
        <line x1="3" y1="10" x2="21" y2="10" />
      </svg>
      Invitations
      @if (communityService.pendingInvitations().length > 0) {
      <span class="tab-badge">{{ communityService.pendingInvitations().length }}</span>
      }
    </button>
    <button class="tab-btn" [class.active]="activeTab() === 'my-shares'" (click)="setTab('my-shares')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="18" cy="5" r="3" />
        <circle cx="6" cy="12" r="3" />
        <circle cx="18" cy="19" r="3" />
        <line x1="8.59" y1="13.51" x2="15.42" y2="17.49" />
        <line x1="15.41" y1="6.51" x2="8.59" y2="10.49" />
      </svg>
      My Shares
      <span class="tab-count">{{ mySharedSimulations().length }}</span>
    </button>
  </nav>

  <main class="community-content">
    <!-- Explore Tab -->
    @if (activeTab() === 'explore') {
    <div class="explore-section">
      <!-- Search and Filters -->
      <div class="filters-bar">
        <div class="search-box">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8" />
            <line x1="21" y1="21" x2="16.65" y2="16.65" />
          </svg>
          <input type="text" placeholder="Search simulations..." [value]="searchQuery()" (input)="updateSearch($event)">
        </div>

        <div class="filter-group">
          <select [value]="structureFilter()" (change)="structureFilter.set($any($event.target).value)">
            @for (type of structureTypes; track type) {
            <option [value]="type">{{ type === 'all' ? 'All Structures' : type | titlecase }}</option>
            }
          </select>

          <select [value]="materialFilter()" (change)="materialFilter.set($any($event.target).value)">
            @for (mat of materials; track mat) {
            <option [value]="mat">{{ mat === 'all' ? 'All Materials' : mat | titlecase }}</option>
            }
          </select>

          <select [value]="sortBy()" (change)="sortBy.set($any($event.target).value)">
            <option value="recent">Most Recent</option>
            <option value="popular">Most Popular</option>
            <option value="views">Most Viewed</option>
          </select>
        </div>
      </div>

      <!-- Simulations Grid -->
      <div class="simulations-grid">
        @for (sim of filteredSimulations(); track sim.id) {
        <article class="simulation-card" [class.own-simulation]="sim.isOwner" (click)="viewSimulation(sim)"
          (keydown.enter)="viewSimulation(sim)" tabindex="0" role="button" aria-label="View simulation details">
          <div class="sim-preview">
            <div class="preview-placeholder">
              <span class="structure-icon">
                @switch (sim.structureType.toLowerCase()) {
                @case ('beam') { ‚ïê‚ïê‚ïê }
                @case ('frame') { ‚ïî‚ïê‚ïó }
                @case ('truss') { ‚ñ≥‚ñ≥‚ñ≥ }
                @case ('column') { ‚ïë‚ïë‚ïë }
                }
              </span>
            </div>
            <div class="sim-tags">
              @if (sim.isOwner) {
              <span class="tag owner-tag">Your Simulation</span>
              }
              @for (tag of sim.tags.slice(0, 2); track tag) {
              <span class="tag">{{ tag }}</span>
              }
            </div>
            @if (sim.isOwner) {
            <button class="share-btn" (click)="openShareModal(sim, $event)" title="Share this simulation">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="18" cy="5" r="3" />
                <circle cx="6" cy="12" r="3" />
                <circle cx="18" cy="19" r="3" />
                <line x1="8.59" y1="13.51" x2="15.42" y2="17.49" />
                <line x1="15.41" y1="6.51" x2="8.59" y2="10.49" />
              </svg>
            </button>
            }
          </div>

          <div class="sim-content">
            <h3>{{ sim.name }}</h3>
            <p class="sim-description">{{ sim.description }}</p>

            <div class="sim-author">
              <div class="author-avatar">{{ getInitials(sim.owner.name) }}</div>
              <div class="author-info">
                <span class="author-name">{{ sim.isOwner ? 'You' : sim.owner.name }}</span>
                <span class="sim-date">{{ getTimeAgo(sim.sharedAt) }}</span>
              </div>
            </div>

            <div class="sim-stats">
              @if (!sim.isOwner) {
              <button class="stat-btn" (click)="likeSimulation(sim, $event)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path
                    d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z" />
                </svg>
                {{ sim.likes }}
              </button>
              } @else {
              <span class="stat">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path
                    d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z" />
                </svg>
                {{ sim.likes }}
              </span>
              }
              <span class="stat">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" />
                </svg>
                {{ sim.comments }}
              </span>
              <span class="stat">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" />
                  <circle cx="12" cy="12" r="3" />
                </svg>
                {{ sim.views }}
              </span>
            </div>
          </div>
        </article>
        } @empty {
        <div class="empty-state">
          <div class="empty-icon">üîç</div>
          <h3>No simulations found</h3>
          <p>Try adjusting your search or filters</p>
        </div>
        }
      </div>
    </div>
    }

    <!-- Friends Tab -->
    @if (activeTab() === 'friends') {
    <div class="friends-section">
      <div class="friends-header">
        <div class="header-title">
          <h2>Your Network</h2>
          <p class="header-description">Connect and collaborate with your professional network</p>
        </div>
        <div class="header-stats">
          <div class="stat-item">
            <span class="stat-number">{{ communityService.allFriends().length }}</span>
            <span class="stat-label">Connections</span>
          </div>
          @if (pendingRequests().length > 0) {
          <div class="stat-item pending">
            <span class="stat-number">{{ pendingRequests().length }}</span>
            <span class="stat-label">Pending</span>
          </div>
          }
        </div>
      </div>

      <!-- Pending Friend Requests -->
      @if (pendingRequests().length > 0) {
      <div class="requests-section">
        <div class="section-title">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
            <circle cx="8.5" cy="7" r="4" />
            <line x1="20" y1="8" x2="20" y2="14" />
            <line x1="23" y1="11" x2="17" y2="11" />
          </svg>
          <h3>Friend Requests</h3>
          <span class="count-badge">{{ pendingRequests().length }}</span>
        </div>
        <div class="requests-list">
          @for (friend of pendingRequests(); track friend.friendshipId) {
          <div class="request-card">
            <div class="request-avatar">
              @if (friend.avatarUrl) {
              <img [src]="friend.avatarUrl" alt="">
              } @else {
              <span>{{ getInitials(friend.name) }}</span>
              }
            </div>
            <div class="request-info">
              <h4>{{ friend.name }}</h4>
              <span class="request-email">{{ friend.email }}</span>
              @if (friend.company) {
              <span class="request-company">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z" />
                  <circle cx="12" cy="10" r="3" />
                </svg>
                {{ friend.company }}
              </span>
              }
            </div>
            <div class="request-actions">
              <button class="btn btn-primary" (click)="acceptFriendRequest(friend)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="20 6 9 17 4 12" />
                </svg>
                Accept
              </button>
              <button class="btn btn-outline" (click)="rejectFriendRequest(friend)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="18" y1="6" x2="6" y2="18" />
                  <line x1="6" y1="6" x2="18" y2="18" />
                </svg>
                Decline
              </button>
            </div>
          </div>
          }
        </div>
      </div>
      }

      <!-- Friends List -->
      @if (communityService.allFriends().length > 0) {
      <div class="section-title friends-title">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
          <circle cx="9" cy="7" r="4" />
          <path d="M23 21v-2a4 4 0 0 0-3-3.87" />
          <path d="M16 3.13a4 4 0 0 1 0 7.75" />
        </svg>
        <h3>All Connections</h3>
      </div>
      }
      <div class="friends-grid">
        @for (friend of communityService.allFriends(); track friend.id) {
        <div class="friend-card">
          <div class="card-header">
            <div class="friend-avatar">
              @if (friend.avatarUrl) {
              <img [src]="friend.avatarUrl" alt="">
              } @else {
              <span>{{ getInitials(friend.name) }}</span>
              }
              <span class="status-indicator" [class]="friend.status?.toLowerCase() || 'offline'"></span>
            </div>
            <div class="friend-quick-actions">
              <button class="quick-action-btn chat-btn" (click)="openChat(friend)" title="Send message">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" />
                </svg>
              </button>
            </div>
          </div>

          <div class="friend-info">
            <h4 class="friend-name">{{ friend.name }}</h4>
            <span class="friend-email">{{ friend.email }}</span>
            @if (friend.company) {
            <div class="friend-company">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="2" y="7" width="20" height="14" rx="2" ry="2" />
                <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16" />
              </svg>
              {{ friend.company }}
            </div>
            }
            @if (friend.connectedAt) {
            <div class="friend-connected">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10" />
                <polyline points="12 6 12 12 16 14" />
              </svg>
              Connected {{ getTimeAgo(friend.connectedAt) }}
            </div>
            }
          </div>

          <div class="card-footer">
            <button class="action-btn primary" (click)="openChat(friend)">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" />
              </svg>
              Message
            </button>
            <button class="action-btn secondary remove-btn" (click)="removeFriend(friend)">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
                <circle cx="8.5" cy="7" r="4" />
                <line x1="18" y1="11" x2="23" y2="11" />
              </svg>
              Remove
            </button>
          </div>
        </div>
        } @empty {
        <div class="empty-state">
          <div class="empty-illustration">
            <svg viewBox="0 0 200 200" fill="none">
              <circle cx="100" cy="100" r="80" fill="var(--primary-100)" opacity="0.5" />
              <circle cx="70" cy="80" r="25" fill="var(--primary-200)" />
              <circle cx="130" cy="80" r="25" fill="var(--primary-200)" />
              <path d="M60 140 Q100 170 140 140" stroke="var(--primary-400)" stroke-width="4" fill="none" />
              <circle cx="70" cy="80" r="15" fill="var(--primary-300)" />
              <circle cx="130" cy="80" r="15" fill="var(--primary-300)" />
            </svg>
          </div>
          <h3>Build Your Network</h3>
          <p>Connect with colleagues and collaborators to share simulations and insights</p>
          <button class="btn btn-primary btn-lg" (click)="openInviteModal()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
              <circle cx="8.5" cy="7" r="4" />
              <line x1="20" y1="8" x2="20" y2="14" />
              <line x1="23" y1="11" x2="17" y2="11" />
            </svg>
            Invite Friends
          </button>
        </div>
        }
      </div>
    </div>
    }

    <!-- Invitations Tab -->
    @if (activeTab() === 'invitations') {
    <div class="invitations-section">
      <h2>Pending Invitations</h2>

      @if (receivedInvitations().length === 0) {
      <div class="empty-state">
        <div class="empty-icon">üì¨</div>
        <h3>No pending invitations</h3>
        <p>When someone invites you to collaborate, it will appear here</p>
      </div>
      } @else {
      <div class="invitations-list">
        @for (inv of receivedInvitations(); track inv.id) {
        <div class="invitation-card" [class.expired]="inv.isExpired">
          <div class="inv-avatar">
            <span>{{ getInitials(inv.senderName) }}</span>
          </div>

          <div class="inv-content">
            <div class="inv-header">
              <strong>{{ inv.senderName }}</strong>
              <span class="inv-email">{{ inv.senderEmail }}</span>
              <span class="inv-time">{{ getTimeAgo(inv.createdAt) }}</span>
            </div>

            @if (inv.message) {
            <p class="inv-message">"{{ inv.message }}"</p>
            }

            @if (inv.isExpired) {
            <p class="inv-expired">This invitation has expired</p>
            }

            @if (!inv.isExpired && inv.status === 'PENDING') {
            <div class="inv-actions">
              <button class="btn btn-primary btn-sm" (click)="acceptInvitation(inv)">Accept</button>
              <button class="btn btn-ghost btn-sm" (click)="declineInvitation(inv)">Decline</button>
            </div>
            }
          </div>
        </div>
        }
      </div>
      }

      <!-- Sent Invitations -->
      @if (communityService.allInvitationsSent().length > 0) {
      <h3 class="sent-title">Sent Invitations</h3>
      <div class="invitations-list sent">
        @for (inv of communityService.allInvitationsSent(); track inv.id) {
        <div class="invitation-card sent" [class.expired]="inv.isExpired">
          <div class="inv-content">
            <div class="inv-header">
              <span>To: <strong>{{ inv.recipientEmail }}</strong></span>
              <span class="inv-time">{{ getTimeAgo(inv.createdAt) }}</span>
              <span class="inv-status" [class]="inv.status.toLowerCase()">{{ inv.status }}</span>
            </div>
            @if (inv.message) {
            <p class="inv-message">"{{ inv.message }}"</p>
            }
            @if (inv.status === 'PENDING' && !inv.isExpired) {
            <button class="btn btn-ghost btn-sm" (click)="communityService.cancelInvitation(inv.id)">Cancel</button>
            }
          </div>
        </div>
        }
      </div>
      }
    </div>
    }

    <!-- My Shares Tab -->
    @if (activeTab() === 'my-shares') {
    <div class="my-shares-section">
      <div class="section-header">
        <h2>My Shared Simulations</h2>
        <a routerLink="/simulation" class="btn btn-primary">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="12" y1="5" x2="12" y2="19" />
            <line x1="5" y1="12" x2="19" y2="12" />
          </svg>
          New Simulation
        </a>
      </div>

      @if (mySharedSimulations().length === 0) {
      <div class="empty-state">
        <div class="empty-icon">üì§</div>
        <h3>No shared simulations yet</h3>
        <p>Share your simulations with friends or make them public</p>
        <button class="btn btn-primary" (click)="setTab('explore')">Browse Your Simulations</button>
      </div>
      } @else {
      <div class="simulations-grid">
        @for (sim of mySharedSimulations(); track sim.id) {
        <article class="simulation-card own-simulation" (click)="viewSimulation(sim)"
          (keydown.enter)="viewSimulation(sim)" tabindex="0" role="button" aria-label="View simulation details">
          <div class="sim-preview">
            <div class="preview-placeholder">
              <span class="structure-icon">
                @switch (sim.structureType.toLowerCase()) {
                @case ('beam') { ‚ïê‚ïê‚ïê }
                @case ('frame') { ‚ïî‚ïê‚ïó }
                @case ('truss') { ‚ñ≥‚ñ≥‚ñ≥ }
                @case ('column') { ‚ïë‚ïë‚ïë }
                }
              </span>
            </div>
            <div class="sim-tags">
              <span class="tag owner-tag">Shared</span>
              @if (sim.sharedWith?.length) {
              <span class="tag">{{ sim.sharedWith?.length || 0 }} friends</span>
              }
            </div>
          </div>

          <div class="sim-content">
            <h3>{{ sim.name }}</h3>
            <p class="sim-description">{{ sim.description }}</p>

            <div class="sim-stats">
              <span class="stat">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path
                    d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z" />
                </svg>
                {{ sim.likes }}
              </span>
              <span class="stat">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" />
                </svg>
                {{ sim.comments }}
              </span>
              <span class="stat">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" />
                  <circle cx="12" cy="12" r="3" />
                </svg>
                {{ sim.views }}
              </span>
            </div>
          </div>
        </article>
        }
      </div>
      }
    </div>
    }
  </main>
</div>

<!-- Invite Modal -->
@if (showInviteModal()) {
<div class="modal-overlay" (click)="closeInviteModal()" (keydown.enter)="closeInviteModal()" tabindex="0" role="button"
  aria-label="Close modal" aria-modal="true">
  <div class="modal modal-lg" (click)="$event.stopPropagation()" (keydown.enter)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Add a Friend</h3>
      <button class="close-btn" (click)="closeInviteModal()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18" />
          <line x1="6" y1="6" x2="18" y2="18" />
        </svg>
      </button>
    </div>

    <div class="modal-body">
      <!-- Mode Toggle -->
      <div class="mode-toggle">
        <button class="mode-btn" [class.active]="inviteMode() === 'search'" (click)="setInviteMode('search')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8" />
            <line x1="21" y1="21" x2="16.65" y2="16.65" />
          </svg>
          Find Registered User
        </button>
        <button class="mode-btn" [class.active]="inviteMode() === 'invite'" (click)="setInviteMode('invite')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z" />
            <polyline points="22,6 12,13 2,6" />
          </svg>
          Invite by Email
        </button>
      </div>

      <!-- Error/Suggestion Display -->
      @if (inviteError()) {
      <div class="invite-alert">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10" />
          <line x1="12" y1="8" x2="12" y2="12" />
          <line x1="12" y1="16" x2="12.01" y2="16" />
        </svg>
        <span>{{ inviteError() }}</span>
      </div>
      }

      <!-- Suggested User (from 409 error) -->
      @if (suggestedUser()) {
      <div class="suggested-user-card">
        <p class="suggestion-label">User found - Send a friend request instead:</p>
        <div class="user-result">
          <div class="user-avatar">
            @if (suggestedUser()!.avatarUrl) {
            <img [src]="suggestedUser()!.avatarUrl" alt="">
            } @else {
            <span>{{ getInitials(suggestedUser()!.name) }}</span>
            }
          </div>
          <div class="user-info">
            <h4>{{ suggestedUser()!.name }}</h4>
            <span>{{ suggestedUser()!.email }}</span>
            @if (suggestedUser()!.company) {
            <span class="user-company">{{ suggestedUser()!.company }}</span>
            }
          </div>
          <button class="btn btn-primary btn-sm" (click)="sendFriendRequestToSuggested()" [disabled]="sendingRequest()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
              <circle cx="8.5" cy="7" r="4" />
              <line x1="20" y1="8" x2="20" y2="14" />
              <line x1="23" y1="11" x2="17" y2="11" />
            </svg>
            Send Request
          </button>
        </div>
      </div>
      }

      <!-- Search Mode: Find Registered Users -->
      @if (inviteMode() === 'search') {
      <div class="search-section">
        <div class="form-group">
          <label for="user-search-input">Search for users by name or email</label>
          <div class="search-input-wrapper">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="11" cy="11" r="8" />
              <line x1="21" y1="21" x2="16.65" y2="16.65" />
            </svg>
            <input type="text" placeholder="Search by name or email..." [value]="userSearchQuery()"
              (input)="onUserSearchInput($event)">
            @if (communityService.userSearchLoading()) {
            <div class="search-spinner"></div>
            }
          </div>
        </div>

        <!-- Search Results -->
        <div class="search-results">
          @if (communityService.allUserSearchResults().length > 0) {
          @for (user of communityService.allUserSearchResults(); track user.id) {
          <div class="user-result">
            <div class="user-avatar">
              @if (user.avatarUrl) {
              <img [src]="user.avatarUrl" alt="">
              } @else {
              <span>{{ getInitials(user.name) }}</span>
              }
            </div>
            <div class="user-info">
              <h4>{{ user.name }}</h4>
              <span>{{ user.email }}</span>
              @if (user.company) {
              <span class="user-company">{{ user.company }}</span>
              }
            </div>
            <button class="btn btn-primary btn-sm" (click)="sendFriendRequestTo(user)" [disabled]="sendingRequest()">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
                <circle cx="8.5" cy="7" r="4" />
                <line x1="20" y1="8" x2="20" y2="14" />
                <line x1="23" y1="11" x2="17" y2="11" />
              </svg>
              Add Friend
            </button>
          </div>
          }
          } @else if (userSearchQuery().length >= 2 && !communityService.userSearchLoading()) {
          <div class="no-results">
            <p>No users found matching "{{ userSearchQuery() }}"</p>
            <p class="hint">Try a different search or invite them by email</p>
          </div>
          } @else if (userSearchQuery().length > 0 && userSearchQuery().length < 2) { <div class="search-hint">
            <p>Type at least 2 characters to search</p>
        </div>
        } @else {
        <div class="search-hint">
          <p>Search for registered users to add as friends</p>
        </div>
        }
      </div>
    </div>
    }

    <!-- Invite Mode: Send Email Invitation to Non-Registered User -->
    @if (inviteMode() === 'invite') {
    <div class="invite-section">
      <p class="invite-info">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10" />
          <line x1="12" y1="16" x2="12" y2="12" />
          <line x1="12" y1="8" x2="12.01" y2="8" />
        </svg>
        Use this to invite someone who doesn't have an account yet
      </p>

      <div class="form-group">
        <label for="invite-email">Email Address</label>
        <input type="email" placeholder="friend@example.com" [value]="inviteEmail()"
          (input)="inviteEmail.set($any($event.target).value)">
      </div>

      <div class="form-group">
        <label for="invite-message">Message (optional)</label>
        <textarea placeholder="Add a personal message..." rows="3" [value]="inviteMessage()"
          (input)="inviteMessage.set($any($event.target).value)"></textarea>
      </div>

      <button class="btn btn-primary" (click)="sendInvite()" [disabled]="!inviteEmail()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="22" y1="2" x2="11" y2="13" />
          <polygon points="22 2 15 22 11 13 2 9 22 2" />
        </svg>
        Send Invitation
      </button>
    </div>
    }
  </div>

  <div class="modal-footer">
    <button class="btn btn-ghost" (click)="closeInviteModal()">Close</button>
  </div>
</div>
</div>
}

<!-- Share Modal -->
@if (showShareModal() && selectedSimulation()) {
<div class="modal-overlay" (click)="closeShareModal()" (keydown.enter)="closeShareModal()" tabindex="0" role="button"
  aria-label="Close modal" aria-modal="true">
  <div class="modal modal-lg" (click)="$event.stopPropagation()" (keydown.enter)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Share "{{ selectedSimulation()!.name }}"</h3>
      <button class="close-btn" (click)="closeShareModal()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18" />
          <line x1="6" y1="6" x2="18" y2="18" />
        </svg>
      </button>
    </div>

    <div class="modal-body">
      <p class="share-info">Select friends to share this simulation with:</p>

      <!-- Friends List -->
      <div class="friends-select-list" role="listbox">
        @for (friend of communityService.allFriends(); track friend.id) {
        <div class="friend-select-item" [class.selected]="isFriendSelected(friend.id)"
          (click)="toggleFriendSelection(friend.id)" (keydown.enter)="toggleFriendSelection(friend.id)" tabindex="0"
          role="option" [attr.aria-selected]="isFriendSelected(friend.id) ? 'true' : 'false'">
          <div class="friend-avatar">
            @if (friend.avatarUrl) {
            <img [src]="friend.avatarUrl" alt="">
            } @else {
            <span>{{ getInitials(friend.name) }}</span>
            }
            <span class="status-dot" [style.background]="getStatusColor(friend.status)"></span>
          </div>
          <div class="friend-info">
            <h4>{{ friend.name }}</h4>
            <span>{{ friend.email }}</span>
          </div>
          <div class="select-check">
            @if (isFriendSelected(friend.id)) {
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
              <polyline points="20 6 9 17 4 12" />
            </svg>
            }
          </div>
        </div>
        } @empty {
        <p class="no-friends">No friends yet. Invite some friends first!</p>
        }
      </div>

      <!-- Invite by Email -->
      <div class="invite-section">
        <p>Or invite someone new:</p>
        <button class="btn btn-outline btn-sm" (click)="openInviteModal(selectedSimulation()!)">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
            <circle cx="8.5" cy="7" r="4" />
            <line x1="20" y1="8" x2="20" y2="14" />
            <line x1="23" y1="11" x2="17" y2="11" />
          </svg>
          Invite by Email
        </button>
      </div>

      <!-- Message -->
      <div class="form-group">
        <label for="share-with-message">Add a message (optional)</label>
        <textarea id="share-with-message" placeholder="Check out my simulation..." rows="2" [value]="shareMessage()"
          (input)="shareMessage.set($any($event.target).value)"></textarea>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn btn-ghost" (click)="closeShareModal()">Cancel</button>
      <button class="btn btn-primary" (click)="shareWithFriends()" [disabled]="selectedFriends().size === 0">
        Share with {{ selectedFriends().size }} friend{{ selectedFriends().size !== 1 ? 's' : '' }}
      </button>
    </div>
  </div>
</div>
}