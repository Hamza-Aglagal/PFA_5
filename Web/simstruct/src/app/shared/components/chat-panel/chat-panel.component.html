@if (chatService.chatOpen()) {
  <div class="chat-panel" [class.has-conversation]="chatService.activeConversation()">
    <!-- Chat Header -->
    <div class="chat-header">
      @if (chatService.activeConversation()) {
        <button class="back-btn" (click)="chatService.clearActiveConversation()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 12H5M12 19l-7-7 7-7"/>
          </svg>
        </button>
        <div class="chat-user-info">
          <div class="chat-avatar">
            <span>{{ getInitials(chatService.activeConversation()!.otherParticipant.name) }}</span>
            <span class="status-dot online"></span>
          </div>
          <div class="chat-user-details">
            <span class="chat-user-name">{{ chatService.activeConversation()!.otherParticipant.name }}</span>
            <span class="chat-user-status">Available</span>
          </div>
        </div>
      } @else {
        <h3 class="chat-title">Messages</h3>
        @if (chatService.totalUnreadCount() > 0) {
          <span class="unread-badge">{{ chatService.totalUnreadCount() }}</span>
        }
      }
      <button class="close-btn" (click)="chatService.closeChat()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"/>
          <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
    </div>

    <!-- Chat Content -->
    <div class="chat-content">
      @if (chatService.activeConversation()) {
        <!-- Messages View -->
        <div class="messages-container" #messagesContainer>
          @if (chatService.activeMessages().length === 0) {
            <div class="empty-messages">
              <span class="empty-icon">ðŸ’¬</span>
              <p>No messages yet</p>
              <p class="empty-hint">Start the conversation!</p>
            </div>
          } @else {
            @for (message of chatService.activeMessages(); track message.id) {
              <div class="message" [class.own]="isOwnMessage(message)">
                @if (!isOwnMessage(message)) {
                  <div class="message-avatar">
                    {{ getInitials(message.senderName) }}
                  </div>
                }
                <div class="message-content">
                  <div class="message-bubble">
                    {{ message.content }}
                  </div>
                  <span class="message-time">
                    {{ chatService.formatMessageTime(message.sentAt) }}
                  </span>
                </div>
              </div>
            }
          }
        </div>

        <!-- Message Input -->
        <div class="message-input-container">
          <input
            type="text"
            class="message-input"
            placeholder="Type a message..."
            [value]="messageInput()"
            (input)="updateInput($event)"
            (keydown)="handleKeyPress($event)"
          />
          <button 
            class="send-btn" 
            (click)="sendMessage()"
            [disabled]="!messageInput().trim()"
          >
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="22" y1="2" x2="11" y2="13"/>
              <polygon points="22 2 15 22 11 13 2 9 22 2"/>
            </svg>
          </button>
        </div>
      } @else {
        <!-- Conversations List -->
        <div class="conversations-list">
          @if (chatService.allConversations().length === 0) {
            <div class="empty-conversations">
              <span class="empty-icon">ðŸ’¬</span>
              <p>No conversations yet</p>
              <p class="empty-hint">Start chatting with friends from the Community page</p>
            </div>
          } @else {
            @for (conv of chatService.allConversations(); track conv.id) {
              <button class="conversation-item" (click)="chatService.selectConversation(conv.id)">
                <div class="conv-avatar">
                  <span>{{ getInitials(conv.otherParticipant.name) }}</span>
                  <span class="status-dot online"></span>
                </div>
                <div class="conv-info">
                  <div class="conv-header">
                    <span class="conv-name">{{ conv.otherParticipant.name }}</span>
                    @if (conv.lastMessage) {
                      <span class="conv-time">{{ chatService.getTimeAgo(conv.lastMessage.sentAt) }}</span>
                    }
                  </div>
                  @if (conv.lastMessage) {
                    <p class="conv-preview" [class.unread]="conv.unreadCount > 0">
                      {{ conv.lastMessage.senderName === 'You' ? 'You: ' : '' }}{{ conv.lastMessage.content }}
                    </p>
                  } @else {
                    <p class="conv-preview empty">Start a conversation</p>
                  }
                </div>
                @if (conv.unreadCount > 0) {
                  <span class="conv-unread">{{ conv.unreadCount }}</span>
                }
              </button>
            }
          }
        </div>
      }
    </div>
  </div>
}

<!-- Chat Toggle Button (when panel is closed) -->
@if (!chatService.chatOpen()) {
  <button class="chat-toggle-btn" (click)="chatService.openChat()">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
    </svg>
    @if (chatService.totalUnreadCount() > 0) {
      <span class="chat-badge">{{ chatService.totalUnreadCount() }}</span>
    }
  </button>
}
